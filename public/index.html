<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Bender âˆž</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script src="./RTCMultiConnection.min.js"></script>
    <script src="https://cdn.webrtc-experiment.com/getMediaElement.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" 
      integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" 
      crossorigin="anonymous">
    </script>
    <script src="https://unpkg.com/webrtc-adapter/out/adapter.js"></script>
    <!-- <script src="https://aframe.io/releases/0.5.0/aframe.min.js"></script> -->
    <!-- <script type="text/javascript" src="bundle.js" charset="utf-8"></script> -->
    <script src="./build.js"></script>
    <script src="./app.js"></script>
    <!-- <script src="//cdn.rawgit.com/donmccurdy/aframe-physics-system/v1.2.1/dist/aframe-physics-system.min.js"></script> -->
    <!-- <script src="https://unpkg.com/aframe-video-billboard"></script>  -->
    <!-- <script src="https://unpkg.com/aframe-click-drag-component"></script> -->
    <script src="./aframe-cubemap-component.js"></script>
  </head>

  <body onload="startTime()">
    <!-- nav bar -->
    <div id="collapseUI">
      <button id="dcCollapse" onClick="collapse('drawingContainer')">draw</button>
      <button id="chatCollapse" onClick="collapse('chat')">chat</button>
      <button id="clockCollapse" onClick="collapse('clock')">clock</button>
      <button onClick="spawnCube()">spawn cube</button>
      <!-- <section class="experiment"> -->
      <!-- <div class="make-center"> -->
      <input type="text" id="room-id" value="abcdef" autocorrect=off autocapitalize=off size=20>
      <button id="open-room">Open Room</button>
      <button id="join-room">Join Room</button>
      <button id="open-or-join-room">Auto Open Or Join Room</button>
      <div id="room-urls"></div>
    </div>
    <!-- A SMOKING CRATER -->
<!--     <div class="github-TEAMBENDERBITCHES"></div>
      <section class="experiment">
        <div class="make-center">
          <input type="text" id="room-id" value="abcdef" autocorrect=off autocapitalize=off size=20>
          <button id="open-room">Open Room</button>
          <button id="join-room">Join Room</button>
          <button id="open-or-join-room">Auto Open Or Join Room</button>
          <div id="room-urls"></div>
        </div>
      </section>          
    </div> -->

    <!-- ugh -->
    <div id="videos-container"></div>
    

    <!-- A frame scene  -->
    <div id="scene-and-chat">
	    <div id="aframe-div">
	    	<a-scene id="aframe-scene">
					<a-assets>	
				  </a-assets>
				  <!-- background image -->
				   <a-entity cubemap="folder: /images/textures/SanFrancisco4/"></a-entity>
				   <!-- <a-collada-model src="#table" position="0 -15 0" scale="20 20 20" transparent="true" opacity="0.2"></a-collada-model> -->
				   <!-- table top -->
				 
				   <a-cylinder static-body transparent="true" opacity="2" color="#424242" height="0.5" radius="10" position="0 -3 0"></a-cylinder>
				  
		      <a-video-billboard id="guest1" video-billboard="minWidth: 10;" position="-8.66 1.25 -5" rotation ="0 60 0"></a-video-billboard>

		      <a-video-billboard id="guest2" video-billboard="minWidth: 10;" position="8.66 1.25 -5" rotation ="0 -60 0"></a-video-billboard>
		      <a-entity id="camera-wrapper" position="0 0 10">
		      	<a-camera wasd-controls-enabled="true"></a-camera>
		      </a-entity>

          <a-box click-drag dynamic-body color="red" position="0 5 0"></a-box>
          <a-box click-drag dynamic-body color="green" position="0.5 7 0"></a-box>
          <a-box click-drag dynamic-body color="yellow" position="-0.5 9 0"></a-box>
          <a-box click-drag dynamic-body color="blue" position="0 11 0.5"></a-box>
          <a-box click-drag dynamic-body color="purple" position="0 13 -0.5"></a-box>
		    </a-scene>
	    </div>
	  </div>

    <!-- clock -->
    <div id="clockContainer" style="display: block">
      <div id="clock"></div>
    </div>

    <!-- react?????? -->
    <div id="app"></div>

    <!-- drawing -->
    <div id="drawingContainer" style="display: none">
      <canvas id="canvas">
      </canvas>
      <input id="clearDrawing" type="button" value="Clear" name="clear" onclick="clearIt()">
      <h3 style="float: right;">Draw with friends</h3>
    </div>

    <!-- speech transcription chat -->
    <div id="chat" style="display: none">
      <ul>
        <li><h3 style="float: inherit; margin-left: 6px;">Chat</h3></li>
        <li><h3 id="startVoice" style="float: inherit; margin-left: 6px;">Start Voice Chat</h3></li>
        <li><h3 id="endVoice" style="float: inherit; margin-left: 6px;">End Voice Chat</h3></li>
      </ul>
      <div id="message-log">
        <ul id="messages"></ul>
      </div>
      <div>
        <form id="sendMessage" action="">
          <input type="text" x-webkit-speech id="m" autocomplete="off" /><button id="sendTextMessage">Send</button>
        </form>
       </div>
      </div>    


			<script>
          var spawnCube = function() {
            var colors = ['red', 'orange', 'yellow', 'green', 'blue', 'purple'];
            var randomColor = colors[Math.floor(Math.random() * colors.length)];
            var someString = '<a-box color="' + randomColor + '" position="0 10 0"></a-box>'
            var wrapper = document.createElement('div');
            wrapper.innerHTML = someString;
            var newElem = wrapper.firstChild;
            document.getElementById('aframe-scene').appendChild(newElem)
            newElem.setAttribute('dynamic-body', '')
            newElem.setAttribute('click-drag', '')
          }
          
          var collapse = function(elem) {
            var elemDisplay = document.getElementById(elem).style.display
            if (elemDisplay == 'none' || !elemDisplay) { document.getElementById(elem).style.display = 'block'; }
            else { document.getElementById(elem).style.display = 'none'}
          }

					//start voice chat
					$('#startVoice').click(function () {
						console.log('voice chat activated');
						recognition.start();
					});

					$('#endVoice').click(function () {
						recognition.stop();
						console.log('voice chat stopped');
					})

					var socket = io();

			  	$('#sendTextMessage').click(function(e){
			  		console.log('text message sent');
			  		e.preventDefault();
			    	socket.emit('chat message', $('#m').val());
				    $('#m').val('');
				    return false;
			  	});
			  		
			  	socket.on('chat message', function(msg){
			  		var time = new Date();
    				time = Date().substring(0, 16) + time.toLocaleString('en-US', { hour: 'numeric',minute:'numeric', hour12: true });
			  		console.log('chatting in socket');
				    var ul = document.getElementById('messages');
				    var input = document.getElementById('m');

				    li = document.createElement('LI');
				    li.innerHTML = socket.nsp + ' says: ' + msg + '\n' + time;
				    ul.appendChild(li);
				    li.scrollIntoView();
				    // if(ul.offsetHeight >= div.offsetHeight){
				    //     ul.style.height = div.offsetHeight + "px";
				    //   }
			   		//$('#messages').append($('<li>').text(socket.nsp + ' says: ' + msg));
			  		console.log('message to append: ', msg)
			  	});
				  	
				  	//********************************* shared drawing ****************************
					var mouse = { 
			      click: false,
			      move: false,
			      pos: {x:0, y:0},
			      pos_prev: false
					};
				   // get canvas element and create context
				   var canvas  = document.getElementById('canvas');
				   var context = canvas.getContext('2d');
				   var width   = 200;
				   var height  = 250;
				   var socket  = io.connect();
				   var radius = 10;
				   context.lineWidth = radius * 2;

				   // set canvas to full browser width/height
				   canvas.width = width;
				   canvas.height = height;

				  canvas.onmousedown = function(e){ 
      		console.log('mouse down')
      		mouse.click = true; };
   				canvas.onmouseup = function(e){ mouse.click = false; };

			   	canvas.onmousemove = function(e) {
			         // console.log('drawing')
			      // normalize mouse position to range 0.0 - 1.0
			      mouse.pos.x = e.clientX / width;
			      mouse.pos.y = e.clientY / height;
			      mouse.move = true;
			   	};

   				// draw line received from server
				   socket.on('draw_line', function (data) {
            console.log('WE DREW A LINE')
				      var line = data.line;
				      context.beginPath();
				      context.moveTo(line[0].x * width, line[0].y * height);
				      context.lineTo(line[1].x * width, line[1].y * height);
				      context.stroke();
				   });
   
					   // main loop, running every 25ms
					   function mainLoop() {
					      // check if the user is drawing
					      if (mouse.click && mouse.move && mouse.pos_prev) {
					      console.log('sending to server socket')
					         // send line to to the server
					         socket.emit('draw_line', { line: [ mouse.pos, mouse.pos_prev ] });
					         mouse.move = false;
					      }
					      mouse.pos_prev = {x: mouse.pos.x, y: mouse.pos.y};
					      setTimeout(mainLoop, 25);
					   }
					   mainLoop();
				 //   var putPoint = function (e) {c
				 //   	if(mouse.drawing) {
					//    	console.log('drawing')
					//     mouse.click = true; 
					//     mouse.pos.x = e.offsetX / width
					//     mouse.pos.y = e.offsetY / height
					//     context.lineTo(e.offsetX, e.offsetY)
					//     var secondPoint = (context.lineTo(e.offsetX, e.offsetY))
					//     context.stroke();
					//     context.beginPath();
					//     //context.arc(e.offsetX, e.offsetY,radius, 0, Math.PI*2);
					//     context.lineCap="round"
					//     context.fill();
					//     context.beginPath();
					//     context.moveTo(e.offsetX, e.offsetY);
					//     var secondPoint = (context.moveTo(e.offsetX, e.offsetY))
					//     //socket.emit('draw_line', { line: [prev, current],  });
					//     console.log('client socket emit to server');
				 //   	}
				 //   };

				 //   //commenting out drawing a point 
				 //   var engage = function (e) {
				 //   	console.log('point added, start drawing')
				 //   	mouse.drawing = true;
				 //   	putPoint(e);
				 //   	socket.broadcast.emit('draw_line', { line: [ mouse.pos, mouse.pos_prev ] });
				 //   	console.log('client socket emit to server')
				 //   };

				 //   var disengage = function () {
				 //   	console.log('not drawing')
				 //   	mouse.drawing = false;
				 //   	context.beginPath();
				 //   };

				 //  canvas.addEventListener('mousemove', putPoint);
				 //  canvas.addEventListener('mousedown', engage);
				 //  canvas.addEventListener('mouseup', disengage)

					// // socket.on('draw_line', function (data) {
					// // 	console.log('receiving drawing from everyone', data)
			  // //     var line = data.line;
			  // //     context.beginPath();
			  // //     context.moveTo(line[0].x * width, line[0].y * height);
			  // //     context.lineTo(line[1].x * width, line[1].y * height);
			  // //     context.stroke();
				 // //   });

					function clearIt () {
						context.clearRect(0,0,width,height)
						socket.emit('clear drawing');
					};

					// function mainLoop() {
     //  		// check if the user is drawing
     //  			if (mouse.click && mouse.move && mouse.pos_prev) {
     //  				console.log('drawing and sending to server socket')
	    //      	// send line to to the server
	    //      	socket.broadcast.emit('draw_line', { line: [ mouse.pos, mouse.pos_prev ] });
     //     		mouse.move = false;
				 //  	}
				 //      mouse.pos_prev = {x: mouse.pos.x, y: mouse.pos.y};
				 //      setTimeout(mainLoop, 25);
				 //  	}
   		// 			mainLoop();

			
				   //****************************** end shared drawing ****************************
           //****************************** webRTC GHETTO *********************************
            // ......................................................
            // .......................UI Code........................
            // ......................................................

            document.getElementById('open-room').onclick = function() {
                disableInputButtons();
                connection.open(document.getElementById('room-id').value, function() {
                    showRoomURL(connection.sessionid);
                });
            };

            document.getElementById('join-room').onclick = function() {
                disableInputButtons();
                connection.join(document.getElementById('room-id').value);
            };

            document.getElementById('open-or-join-room').onclick = function() {
                disableInputButtons();
                connection.openOrJoin(document.getElementById('room-id').value, function(isRoomExists, roomid) {
                    if(!isRoomExists) {
                        showRoomURL(roomid);
                    }
                });
            };

            // ......................................................
            // ..................RTCMultiConnection Code.............
            // ......................................................

            var connection = new RTCMultiConnection();

            // by default, socket.io server is assumed to be deployed on your own URL
            connection.socketURL = '/';

            connection.socketMessageEvent = 'video-conference-demo';

            connection.session = {
                audio: true,
                video: true
            };

            connection.sdpConstraints.mandatory = {
                OfferToReceiveAudio: true,
                OfferToReceiveVideo: true
            };

            connection.videosContainer = document.getElementById('videos-container');
            connection.onstream = function(event) {
                var width = parseInt(connection.videosContainer.clientWidth / 2) - 20;
                var mediaElement = getMediaElement(event.mediaElement, {
                    title: event.userid,
                    buttons: ['full-screen'],
                    width: width,
                    showOnMouseEnter: false
                });

                connection.videosContainer.appendChild(mediaElement);

                setTimeout(function() {
                    mediaElement.media.play();
                }, 5000);

                mediaElement.id = event.streamid;
            };

            connection.onstreamended = function(event) {
                var mediaElement = document.getElementById(event.streamid);
                if(mediaElement) {
                    mediaElement.parentNode.removeChild(mediaElement);
                }
            };

            function disableInputButtons() {
                document.getElementById('open-or-join-room').disabled = true;
                document.getElementById('open-room').disabled = true;
                document.getElementById('join-room').disabled = true;
                document.getElementById('room-id').disabled = true;
            }

            // ......................................................
            // ......................Handling Room-ID................
            // ......................................................

            function showRoomURL(roomid) {
                var roomHashURL = '#' + roomid;
                var roomQueryStringURL = '?roomid=' + roomid;

                var html = '<h2>Unique URL for your room:</h2><br>';

                html += 'Hash URL: <a href="' + roomHashURL + '" target="_blank">' + roomHashURL + '</a>';
                html += '<br>';
                html += 'QueryString URL: <a href="' + roomQueryStringURL + '" target="_blank">' + roomQueryStringURL + '</a>';

                var roomURLsDiv = document.getElementById('room-urls');
                roomURLsDiv.innerHTML = html;

                roomURLsDiv.style.display = 'block';
            }

            (function() {
                var params = {},
                    r = /([^&=]+)=?([^&]*)/g;

                function d(s) {
                    return decodeURIComponent(s.replace(/\+/g, ' '));
                }
                var match, search = window.location.search;
                while (match = r.exec(search.substring(1)))
                    params[d(match[1])] = d(match[2]);
                window.params = params;
            })();

            var roomid = '';
            if (localStorage.getItem(connection.socketMessageEvent)) {
                roomid = localStorage.getItem(connection.socketMessageEvent);
            } else {
                roomid = connection.token();
            }
            document.getElementById('room-id').value = roomid;
            document.getElementById('room-id').onkeyup = function() {
                localStorage.setItem(connection.socketMessageEvent, this.value);
            };

            var hashString = location.hash.replace('#', '');
            if(hashString.length && hashString.indexOf('comment-') == 0) {
              hashString = '';
            }

            var roomid = params.roomid;
            if(!roomid && hashString.length) {
                roomid = hashString;
            }

            if(roomid && roomid.length) {
                document.getElementById('room-id').value = roomid;
                localStorage.setItem(connection.socketMessageEvent, roomid);

                // auto-join-room
                (function reCheckRoomPresence() {
                    connection.checkPresence(roomid, function(isRoomExists) {
                        if(isRoomExists) {
                            connection.join(roomid);
                            return;
                        }

                        setTimeout(reCheckRoomPresence, 5000);
                    });
                })();

                disableInputButtons();
            }
			</script>
		</script>
  </body>
</html>
